# Story 2.1: Supabase Production Environment Setup

## Status
Draft

## Story
**As a** system administrator,  
**I want** to configure a production Supabase project with proper security policies and environment separation,  
**so that** the Crisis Suite has a secure, scalable backend infrastructure ready for production use.

## Acceptance Criteria
1. Production Supabase project is created and configured with appropriate naming and organization.
2. Row Level Security (RLS) policies are properly configured for all database tables.
3. Environment variables are securely managed for production, staging, and development environments.
4. Database backup and recovery procedures are established and documented.
5. API rate limiting and security headers are configured appropriately.

## Tasks / Subtasks
- [ ] Create production Supabase project (AC: 1)
  - [ ] Sign up/login to Supabase dashboard
  - [ ] Create new project with naming convention: "crisis-suite-prod"
  - [ ] Configure project settings (region, instance size)
  - [ ] Document project credentials securely
  
- [ ] Configure database schema and migrations (AC: 1)
  - [ ] Apply existing database schema from `/apps/supabase/migrations` 
  - [ ] Verify all tables are created: users, crises, bob_entries, tasks, communications, activities
  - [ ] Verify all relationships and constraints are properly set

- [ ] Implement Row Level Security (RLS) policies (AC: 2)
  - [ ] Enable RLS on users table
    - [ ] Policy: Users can read their own data
    - [ ] Policy: Users can update their own profile
  - [ ] Enable RLS on crises table
    - [ ] Policy: Authenticated users can read all crises
    - [ ] Policy: Only admin role can create/update/delete crises
  - [ ] Enable RLS on bob_entries table
    - [ ] Policy: Authenticated users can read entries
    - [ ] Policy: Authenticated users can create entries
    - [ ] Policy: Users can only update/delete their own entries
  - [ ] Enable RLS on tasks table
    - [ ] Policy: Authenticated users can read all tasks
    - [ ] Policy: Assignees can update task status
    - [ ] Policy: Admin role can create/delete tasks
  - [ ] Enable RLS on communications table
    - [ ] Policy: Authenticated users can read/create communications
    - [ ] Policy: Users can only update/delete their own communications
  - [ ] Enable RLS on activities table
    - [ ] Policy: Authenticated users can read activities
    - [ ] Policy: System/admin can create activities
  - [ ] Test all RLS policies with different user roles

- [ ] Setup environment variable management (AC: 3)
  - [ ] Create `.env.production` file template
  - [ ] Create `.env.staging` file template  
  - [ ] Update `.env.local` for development
  - [ ] Configure Vercel environment variables for:
    - [ ] NEXT_PUBLIC_SUPABASE_URL
    - [ ] NEXT_PUBLIC_SUPABASE_ANON_KEY
    - [ ] SUPABASE_SERVICE_ROLE_KEY (server-side only)
  - [ ] Document environment variable usage in README

- [ ] Configure database backup and recovery (AC: 4)
  - [ ] Enable Point-in-Time Recovery (PITR) in Supabase dashboard
  - [ ] Set up daily automated backups
  - [ ] Document backup restoration procedure
  - [ ] Test backup restoration in staging environment
  - [ ] Create runbook for database recovery scenarios

- [ ] Configure API security and rate limiting (AC: 5)
  - [ ] Configure API rate limits in Supabase dashboard
    - [ ] Set appropriate limits for anonymous users
    - [ ] Set appropriate limits for authenticated users
  - [ ] Configure CORS settings for production domain
  - [ ] Enable security headers:
    - [ ] X-Frame-Options
    - [ ] X-Content-Type-Options
    - [ ] Strict-Transport-Security
  - [ ] Configure JWT expiry times appropriately
  - [ ] Review and configure Supabase Auth settings:
    - [ ] Email confirmations
    - [ ] Password requirements
    - [ ] Session management

- [ ] Testing and validation
  - [ ] Run integration tests against production database
  - [ ] Verify all RLS policies work correctly
  - [ ] Test backup and restore procedure
  - [ ] Validate API rate limiting is working
  - [ ] Security audit of all configurations

## Dev Notes

### Database Schema
All database tables are defined in [Source: architecture/database-schema-postgresql.md]:
- users (id, email, full_name, role)
- crises (id, name, status, start_time)
- bob_entries (id, crisis_id, author_id, type, content, created_at, linked_from_ids)
- tasks (id, crisis_id, assignee_id, source_decision_id, description, status, created_at)
- communications (id, crisis_id, author_id, content, created_at)
- activities (id, crisis_id, timestamp, description)

### Tech Stack Context
- **Backend Platform**: Supabase ~2.x [Source: architecture/tech-stack.md]
- **Database**: PostgreSQL 15.x managed by Supabase [Source: architecture/tech-stack.md]
- **Authentication**: Supabase Auth ~2.x [Source: architecture/tech-stack.md]
- **API Style**: REST & RPC - using Supabase's auto-generated REST API and RPC for custom logic [Source: architecture/tech-stack.md]

### Project Structure
- Database migrations location: `/apps/supabase/migrations` [Source: architecture/unified-project-structure.md]
- Supabase backend files: `/apps/supabase` [Source: architecture/unified-project-structure.md]
- Database client and schema definitions: `/packages/db` [Source: architecture/unified-project-structure.md]

### Security Requirements
From [Source: architecture/coding-standards.md#security-standards]:
- Always verify user authentication before data access
- Use Supabase Auth for all authentication flows
- Implement Row Level Security (RLS) policies on all tables
- Never store sensitive data in client-side code
- Use structured error objects with consistent format
- Never expose sensitive information in error messages

### Testing Standards
From [Source: architecture/coding-standards.md#testing-standards]:
- Test both success and error scenarios
- Mock external dependencies appropriately
- Minimum 80% code coverage for critical paths
- All database access must use RLS policies

### Environment Configuration
The project uses a monorepo structure with Turborepo [Source: architecture/tech-stack.md]. Environment variables need to be configured at multiple levels:
1. Local development (.env.local)
2. Staging environment (.env.staging)
3. Production environment (.env.production)
4. Vercel deployment settings

### Previous Story Context
No previous stories exist for Epic 2, this is the first story in the production deployment epic.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-12 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
<!-- To be filled by Dev Agent -->

### Debug Log References
<!-- To be filled by Dev Agent -->

### Completion Notes List
<!-- To be filled by Dev Agent -->

### File List
<!-- To be filled by Dev Agent -->

## QA Results
<!-- To be filled by QA Agent -->