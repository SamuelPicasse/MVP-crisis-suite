# Story 2.2: Vercel Production Deployment & CI/CD Pipeline

## Status
Draft

## Story
**As a** development team,  
**I want** to establish automated deployment pipelines with Vercel that handle testing, building, and deploying the Crisis Suite,  
**so that** we can safely and efficiently deploy updates to production with confidence.

## Acceptance Criteria
1. Vercel project is connected to the GitHub repository with proper branch protection rules.
2. Automated CI/CD pipeline runs tests, linting, and builds on every pull request.
3. Production deployments are triggered only from the main branch after all checks pass.
4. Environment variables are securely configured in Vercel for each deployment environment.
5. Database migrations are automatically applied during deployment process.
6. Rollback procedures are documented and tested.

## Tasks / Subtasks
- [ ] Set up Vercel project and GitHub integration (AC: 1)
  - [ ] Create Vercel account/login to Vercel dashboard
  - [ ] Import GitHub repository to Vercel
  - [ ] Configure project settings:
    - [ ] Framework Preset: Next.js
    - [ ] Root Directory: `apps/web`
    - [ ] Build Command: `npm run build`
    - [ ] Output Directory: `.next`
  - [ ] Set up deployment branches:
    - [ ] Production: main branch
    - [ ] Preview: all other branches
  
- [ ] Configure GitHub branch protection rules (AC: 1)
  - [ ] Navigate to GitHub repository settings
  - [ ] Set up main branch protection:
    - [ ] Require pull request reviews before merging
    - [ ] Require status checks to pass before merging
    - [ ] Require branches to be up to date before merging
    - [ ] Include administrators in restrictions
  - [ ] Configure required status checks:
    - [ ] Vercel deployment checks
    - [ ] Test suite completion
    - [ ] Linting checks
    - [ ] Type checking

- [ ] Implement CI/CD pipeline configuration (AC: 2)
  - [ ] Create GitHub Actions workflow file `.github/workflows/ci.yml`
  - [ ] Configure test job:
    - [ ] Checkout code
    - [ ] Setup Node.js environment
    - [ ] Install dependencies with `npm ci`
    - [ ] Run tests: `npm run test`
  - [ ] Configure lint job:
    - [ ] Run ESLint: `npm run lint`
    - [ ] Check for linting errors
  - [ ] Configure type check job:
    - [ ] Run TypeScript compiler: `npm run typecheck`
    - [ ] Ensure no type errors
  - [ ] Configure build job:
    - [ ] Run build: `npm run build`
    - [ ] Verify build success
  - [ ] Set up job dependencies and parallel execution

- [ ] Configure Vercel environment variables (AC: 4)
  - [ ] Access Vercel project settings → Environment Variables
  - [ ] Configure production environment variables:
    - [ ] NEXT_PUBLIC_SUPABASE_URL (from Story 2.1)
    - [ ] NEXT_PUBLIC_SUPABASE_ANON_KEY (from Story 2.1)
    - [ ] SUPABASE_SERVICE_ROLE_KEY (encrypted, server-side only)
  - [ ] Configure preview environment variables:
    - [ ] Use staging Supabase project credentials
  - [ ] Configure development environment variables:
    - [ ] Use development Supabase project credentials
  - [ ] Test environment variable access in deployments

- [ ] Set up database migration automation (AC: 5)
  - [ ] Create migration script `scripts/migrate.js`
  - [ ] Configure Supabase CLI in build process
  - [ ] Update `package.json` scripts:
    - [ ] Add `migrate:deploy` script
    - [ ] Add migration to build process
  - [ ] Create Vercel build configuration:
    - [ ] Install Supabase CLI during build
    - [ ] Run migrations before build completion
  - [ ] Test migration execution in preview deployments
  - [ ] Verify migrations don't run multiple times

- [ ] Configure production deployment settings (AC: 3)
  - [ ] Set up Vercel production deployment rules:
    - [ ] Only deploy from main branch
    - [ ] Require all checks to pass
  - [ ] Configure deployment notifications:
    - [ ] Success notifications
    - [ ] Failure alerts
  - [ ] Set up deployment hooks for monitoring
  - [ ] Configure custom domain (if available)
  - [ ] Set up SSL certificate auto-renewal

- [ ] Document and test rollback procedures (AC: 6)
  - [ ] Document Vercel instant rollback process
  - [ ] Create rollback runbook including:
    - [ ] How to identify deployment issues
    - [ ] Steps to initiate rollback in Vercel dashboard
    - [ ] Database rollback considerations
    - [ ] Communication procedures
  - [ ] Test rollback procedure:
    - [ ] Deploy a test change to production
    - [ ] Execute rollback
    - [ ] Verify application returns to previous state
  - [ ] Document rollback verification steps
  - [ ] Create post-rollback checklist

- [ ] Optimize build and deployment performance
  - [ ] Configure Turborepo for optimal caching
  - [ ] Set up remote caching with Vercel
  - [ ] Optimize Next.js build settings
  - [ ] Configure incremental static regeneration (ISR) if needed
  - [ ] Review and optimize bundle sizes

- [ ] Testing and validation
  - [ ] Create test pull request to verify CI/CD pipeline
  - [ ] Verify all checks run successfully
  - [ ] Test preview deployment creation
  - [ ] Perform production deployment test
  - [ ] Verify rollback procedures work
  - [ ] Load test deployed application

## Dev Notes

### Platform Architecture
From [Source: architecture/high-level-architecture.md]:
- **Frontend Platform**: Vercel for hosting & CI/CD
- **Frontend Framework**: Next.js ~14.x hosted on Vercel's global CDN
- **Monorepo Tool**: Turborepo ~1.x for managing the monorepo and optimizing build processes
- **Architecture**: Frontend (Next.js on Vercel) → Backend (Supabase Platform)

### Tech Stack Context
From [Source: architecture/tech-stack.md]:
- **CI/CD**: Vercel - Seamless, Git-based CI/CD for the frontend and serverless functions
- **Frontend Framework**: Next.js ~14.x - The premier React framework, offering the best performance on Vercel
- **Monorepo Tool**: Turborepo ~1.x - For managing the monorepo and optimizing build processes
- **Testing**: Vitest & RTL ~1.x - Modern and fast testing framework
- **E2E Testing**: Playwright ~1.x - For end-to-end testing of critical user flows

### Project Structure
From [Source: architecture/unified-project-structure.md]:
- Frontend application location: `/apps/web`
- Supabase backend: `/apps/supabase`
- Shared packages: `/packages/*`
- Configuration packages: `/packages/config`, `/packages/eslint-config-custom`, `/packages/tsconfig`

### Coding Standards Requirements
From [Source: architecture/coding-standards.md]:
- **Before Submitting Code** (for CI/CD checks):
  - Run `npm run lint` and fix all issues
  - Run `npm run typecheck` and resolve all type errors  
  - Run `npm run test` and ensure all tests pass
  - Verify functionality in browser/application
- **Compliance Requirements**:
  - TypeScript: Must use strict mode with no `any` types in production code
  - ESLint: All linting rules must pass without warnings
  - Testing: Minimum 80% code coverage for critical paths
  - Performance: Pages must load within 3 seconds on fast connections

### Testing Standards
From [Source: architecture/coding-standards.md#testing-standards]:
- Use Vitest for unit and integration tests
- Use React Testing Library for component testing
- Colocate test files with source files using `.test.ts` or `.test.tsx`
- Test both success and error scenarios
- Mock external dependencies appropriately

### Security Considerations
From [Source: architecture/coding-standards.md#security-standards]:
- Never store sensitive data in client-side code
- Environment variables for sensitive keys must be server-side only
- Use structured error objects with consistent format
- Never expose sensitive information in error messages

### Previous Story Context
Story 2.1 sets up the production Supabase environment. This story (2.2) needs to:
- Use the Supabase credentials from Story 2.1
- Ensure database migrations from `/apps/supabase/migrations` are deployed
- Connect to the production Supabase instance configured in Story 2.1

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-12 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
<!-- To be filled by Dev Agent -->

### Debug Log References
<!-- To be filled by Dev Agent -->

### Completion Notes List
<!-- To be filled by Dev Agent -->

### File List
<!-- To be filled by Dev Agent -->

## QA Results
<!-- To be filled by QA Agent -->