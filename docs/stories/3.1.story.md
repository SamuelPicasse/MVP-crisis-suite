# <!-- Powered by BMADâ„¢ Core -->

# Story 3.1: Core Logging Infrastructure

## Status
Draft

## Story
**As a** developer working on the Crisis Suite system,
**I want** a centralized logging service with configurable levels that integrates seamlessly with our existing Supabase client,
**so that** I can instrument the application for debugging without impacting performance or changing existing API contracts.

## Acceptance Criteria

1. Create a centralized logging service that supports multiple log levels (DEBUG, INFO, WARN, ERROR)
2. Implement configuration via environment variables for different deployment environments
3. Wrap existing Supabase client calls without changing their API interface
4. Ensure async/batched logging to prevent performance impact on user interactions
5. Create structured log format with timestamps, context, and correlation IDs
6. Integrate with existing error handling patterns in ActivityLog component
7. Verify all existing functionality remains unchanged (all current tests pass)

## Tasks / Subtasks

- [ ] Create core logging service infrastructure (AC: 1, 2, 5)
  - [ ] Implement LogService class with configurable levels
  - [ ] Add environment variable configuration (LOG_LEVEL, LOG_ENABLED)
  - [ ] Create structured log entry interface with correlation IDs
  - [ ] Implement async batching mechanism for performance

- [ ] Wrap Supabase client with logging instrumentation (AC: 3, 6)
  - [ ] Create enhanced Supabase client wrapper
  - [ ] Instrument RPC calls (like get_activity_log) with before/after logging
  - [ ] Maintain existing client API contracts
  - [ ] Integrate with current error handling patterns

- [ ] Add logging utilities and context management (AC: 4, 5)
  - [ ] Create request correlation ID system
  - [ ] Implement context-aware logging (component, user, action)
  - [ ] Add performance timing utilities
  - [ ] Create log formatting utilities

- [ ] Testing and verification (AC: 7)
  - [ ] Verify existing ActivityLog component functionality unchanged
  - [ ] Run all current tests to ensure no regressions
  - [ ] Test logging configuration in different environments
  - [ ] Performance test to ensure minimal impact

## Dev Notes

**Existing System Integration:**
- Current Supabase client pattern: `/apps/web/src/lib/supabase/client.ts`
- ActivityLog component already has basic error handling: `console.error('Error fetching activities:', err)`
- Existing RPC call pattern: `supabase.rpc('get_activity_log', params)`

**Architecture Requirements:**
- Must maintain existing client.ts API interface
- Should extend, not replace, current error handling
- Log service should be singleton pattern for consistency
- Environment-based configuration for dev/staging/prod

**Key Integration Points:**
- Wrap `createClient()` function from `/lib/supabase/client.ts`
- Enhance existing try/catch blocks with structured logging
- Maintain ActivityLog.tsx error state management

### Testing
**Testing Standards:**
- Test files location: `apps/web/components/**/*.test.tsx` pattern
- Use Vitest framework (existing in vitest.config.ts)
- Mock Supabase calls for unit tests
- Integration tests should verify no performance impact
- Test both enabled/disabled logging states
- Verify environment variable configuration

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-12 | 1.0 | Initial story creation | Sarah, PO |

## Dev Agent Record
*This section will be populated during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*To be filled by QA agent*